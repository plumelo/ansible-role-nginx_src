---

- hosts: all
  become: true
  vars:
    nginx_preconfigure: true
    nginx_src_deps:
      - libhiredis-dev
    nginx_src_cc_opt: "-I /usr/local/include/hiredis"
    nginx_src_ld_opt: "-L /usr/local/lib"
    nginx_src_libs:
      - name: redis_nginx_adapter
        url: https://github.com/wandenberg/redis_nginx_adapter/archive/1.0.1.tar.gz
        configure: "--with-nginx-dir={{ nginx_src_build_path }}/nginx-{{ nginx_src_version }}/debian/preconfigure-nginx"
        make: install
    nginx_src_modules:
      - name: nginx-selective-cache-purge-module
        url: https://github.com/wandenberg/nginx-selective-cache-purge-module/archive/0.7.0.tar.gz

  roles:
    - role: ansible-role-nginx_src
  pre_tasks:
    - name: Apt install redis-server
      apt: pkg=redis-server
      register: apt_redis_result
      ignore_errors: true

    - name: Modify redis.config
      lineinfile:
        path: /etc/systemd/system/redis.service
        regexp: PrivateDevices=yes
        line: PrivateDevices=no
      when: apt_redis_result.failed|default(false)
      notify:
        - Restart redis.service
