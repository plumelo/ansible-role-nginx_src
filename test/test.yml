---

- hosts: all
  become: true
  vars:
    nginx_src_modules:
      - name: ngx_cache_purge
        url: https://github.com/FRiCKLE/ngx_cache_purge/archive/2.3.tar.gz

      - name: nginx_auto_lib
        url: https://github.com/simpl/ngx_auto_lib/archive/v0.01.tar.gz

      - name: ngx_http_accounting_module
        url: https://github.com/Lax/ngx_http_accounting_module/archive/v1.0.tar.gz

      - name: ngx_devel_kit
        url: https://github.com/simpl/ngx_devel_kit/archive/v0.3.0.tar.gz

      - name: array-var-nginx-module
        url: https://github.com/openresty/array-var-nginx-module/archive/v0.05.tar.gz

  roles:
    - role: ansible-role-nginx_src

  tasks:
    - shell: nginx -V
      register: nginx_modules_register
      changed_when: no

    - debug:
        var: nginx_modules_register

    - assert:
        that:
          - "'{{ item.name }}' in nginx_modules_register.stderr"
        msg: "Module must be added"
      with_items: "{{ nginx_src_modules }}"
